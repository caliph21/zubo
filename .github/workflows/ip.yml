name: FOFA IP & IPTV Sync

on:
  schedule:
    # FOFA ä»»åŠ¡ï¼šæ¯ 15 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    - cron: "*/15 * * * *"
    # IPTV ä»»åŠ¡ï¼šæ¯ 2 å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: "0 */2 * * *"
  workflow_dispatch:          # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  fetch-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Install ffmpeg and wget
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg wget

      # ===== FOFA ä»»åŠ¡éƒ¨åˆ† =====
      - name: Run fofa_fetch.py
        run: python fofa_fetch.py

      # ===== IPTV ä»»åŠ¡éƒ¨åˆ† =====
      - name: Download and Update IPTV Playlists
        run: |
          set -e
          echo "ğŸµ å¼€å§‹ä¸‹è½½ IPTV æ’­æ”¾åˆ—è¡¨..."

          base="https://live.ottiptv.cc"
          files=("yylunbo.m3u" "huyayqk.m3u" "douyuyqk.m3u" "bililive.m3u")

          # ---- åªåœ¨ä¸‹è½½æˆåŠŸåæ‰è¦†ç›–åŸæ–‡ä»¶ ----
          download_with_retry () {
            local url="$1"
            local outfile="$2"
            local tmpfile="${outfile}.tmp"   # ä¸´æ—¶æ–‡ä»¶
            local attempt=1
            local max=5

            rm -f "$tmpfile"                 # ä¿è¯å¹²å‡€èµ·æ­¥
            while [ $attempt -le $max ]; do
              echo "â¡ï¸  [$attempt/$max] ä¸‹è½½ $outfile ..."
              if wget -q --timeout=15 --connect-timeout=10 "$url" -O "$tmpfile"; then
                if [ -s "$tmpfile" ]; then   # æœ‰å†…å®¹æ‰ç®—æˆåŠŸ
                  mv "$tmpfile" "$outfile"
                  echo "âœ… $outfile ä¸‹è½½å¹¶è¦†ç›–å®Œæˆ"

                  # ---- yylunbo.m3u é¢å¤–å¤„ç† ----
                  if [ "$outfile" = "yylunbo.m3u" ]; then
                    sed -i 's#https://live.ottiptv.cc#https://yylunbo.ottiptv.cc#g' "$outfile"
                    echo "ğŸ”§ å·²å°† $outfile ä¸­çš„ live.ottiptv.cc æ›¿æ¢ä¸º yylunbo.ottiptv.cc"
                  fi

                  return 0
                fi
              fi
              echo "âš ï¸  $outfile ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾… $attempt ç§’åé‡è¯•..."
              sleep $attempt
              attempt=$(( attempt + 1 ))
            done

            echo "âŒ $outfile æœ€ç»ˆä¸‹è½½å¤±è´¥ï¼Œä¿ç•™æ—§ç‰ˆæœ¬"
            rm -f "$tmpfile"                 # ä¸åŠ¨æ—§æ–‡ä»¶
            return 1
          }

          # ä¸‹è½½æ‰€æœ‰æ–‡ä»¶ï¼ˆæ³¨æ„ï¼šåŸå§‹ä»£ç ä¸­æ²¡æœ‰ä½¿ç”¨ TOKENï¼‰
          for f in "${files[@]}"; do
            download_with_retry "${base}/${f}" "$f" || true
          done

          echo "ğŸ“Š æ–‡ä»¶ä¸‹è½½çŠ¶æ€ï¼š"
          for f in "${files[@]}"; do
            if [ -s "$f" ]; then
              echo "âœ… $f - $(wc -c < "$f") å­—èŠ‚"
            else
              echo "âŒ $f - æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
            fi
          done

      # ===== ç»Ÿä¸€æäº¤éƒ¨åˆ† =====
      - name: Check for changes and commit
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"
          
          # æ£€æŸ¥æœ‰å“ªäº›æ–‡ä»¶æœ‰å˜æ›´
          echo "ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          
          # æ·»åŠ  FOFA ç›¸å…³çš„æ–‡ä»¶
          git add è®¡æ•°.txt
          git add ip/*.txt || true
          git add iTV.txt || true  # æ ¹æ®æˆªå›¾æ˜¯ iTV.txt
          
          # æ·»åŠ  IPTV ç›¸å…³çš„æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if ls *.m3u 1> /dev/null 2>&1; then
            git add *.m3u
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          else
            # åˆ—å‡ºå˜æ›´çš„æ–‡ä»¶
            echo "ğŸ“ å˜æ›´çš„æ–‡ä»¶ï¼š"
            git diff --cached --name-only
            
            # ç”Ÿæˆæäº¤ä¿¡æ¯
            commit_msg="è‡ªåŠ¨æ›´æ–°ï¼š"
            
            # æ£€æŸ¥ FOFA ç›¸å…³æ–‡ä»¶
            if git diff --cached --name-only | grep -q "è®¡æ•°.txt\|ip/.*\.txt\|iTV.txt"; then
              commit_msg="$commit_msg ç»„æ’­æº"
            fi
            
            # æ£€æŸ¥ IPTV æ’­æ”¾åˆ—è¡¨
            if git diff --cached --name-only | grep -q "\.m3u$"; then
              if [[ "$commit_msg" == *"ç»„æ’­æº"* ]]; then
                commit_msg="$commit_msg å’Œ IPTVæ’­æ”¾åˆ—è¡¨"
              else
                commit_msg="$commit_msg IPTVæ’­æ”¾åˆ—è¡¨"
              fi
            fi
            
            commit_msg="$commit_msg - $(date '+%Y-%m-%d %H:%M:%S')"
            
            git commit -m "$commit_msg"
            echo "âœ… å·²æäº¤å˜æ›´ï¼š$commit_msg"
          fi

      - name: Push changes
        run: |
          git push origin main || echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ²¡æœ‰å˜æ›´æˆ–æƒé™é—®é¢˜"
